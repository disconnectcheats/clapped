;(function($,_,undefined){"use strict";ips.controller.register('nexus.front.store.packagePage',{_productURL:'',initialize:function(){this.on('change','select, input[type="radio"], [name="quantity"], [name="renewal_term"]',this.updatePriceAndStock);this.on('submit','form',this.submitForm);this.on('click','[data-action="toggleImage"]',this.toggleScreenshot);this.on(document,'addToCart.nexus',this.addToCart);this.setup();},setup:function(){this.scope.find('.cNexusProduct_images [data-action="toggleImage"]').first().addClass('cNexusProduct_imageSelected');if(this.scope.find('select,input[type="radio"]').length){this.updatePriceAndStock();}},toggleScreenshot:function(e){e.preventDefault();var clickedImage=$(e.currentTarget);var thumbImage=clickedImage.find('img').attr('src');var fullImage=clickedImage.attr('href');var html=ips.templates.render('nexus.store.productImage',{fullURL:fullImage,thumbURL:thumbImage});this.scope.find('.cNexusProduct_primaryImage').replaceWith(html).end().find('[data-action="toggleImage"]').removeClass('cNexusProduct_imageSelected');clickedImage.addClass('cNexusProduct_imageSelected');$(document).trigger('contentChange',[this.scope.find('.cNexusProduct_primaryImage').parent()]);},submitForm:function(e){var self=this;var form=this.scope.find('form');if(form.attr('data-noajax')){return true;}
e.preventDefault();e.stopPropagation();var formDims=ips.utils.position.getElemDims(form);var formPos=ips.utils.position.getElemPosition(form);var loadingElem=$('<div/>').addClass('ipsLoading');form.after(loadingElem);loadingElem.css({top:formPos.offsetPos.top+'px',left:formPos.offsetPos.left+'px',width:formDims.outerWidth+'px',height:formDims.outerHeight+'px'});this._productURL=form.attr('action');this.trigger('addToCart.nexus',{url:this._productURL,formData:form.serialize()});},addToCart:function(e,data){if(data.url!==this._productURL){return;}
var self=this;ips.getAjax()(data.url,{data:data.formData,type:'post'}).done(function(response){if(self.scope.closest('.ipsDialog').length){var dialogContent=self.scope.closest('.ipsDialog').find('.ipsDialog_content');self.trigger('destroy');dialogContent.html(response.dialog).show();$(document).trigger('contentChange',[dialogContent]);}else{var contentElem=$('<div/>').html(response.dialog);var loadingElem=self.scope.find('form').next('.ipsLoading');ips.getContainer().append(contentElem);var dialogRef=ips.ui.dialog.create({title:self.scope.attr('data-itemTitle'),content:contentElem,forceReload:true,size:'medium'});dialogRef.show();$(document).trigger('contentChange',[contentElem]);loadingElem.remove();self.updatePriceAndStock();}
if(response.cart){$('#elCart_container').replaceWith($('<div>'+response.cart+'</div>').find('.cUserNav_icon'));$('#elCart_sep').removeClass('ipsHide');}
if(!_.isUndefined(response.css)){self.insertCssUrls(response.css);}}).fail(function(response){var loadingElem=self.scope.find('form').next('.ipsLoading');loadingElem.remove();if(response.responseJSON){ips.ui.alert.show({type:'alert',message:response.responseJSON,icon:'warn'});}else{var form=$(e.target).find('form');try{var newForm=$(response.responseText);}catch(err){form.attr('data-noajax','true');form.submit();}
form.replaceWith(newForm);$(document).trigger('contentChange');}});},insertCssUrls:function(urls){if(!urls.length){return;}
_.each(urls,function(url){if(url.indexOf('?')!=-1){url=url+'&v='+ips.getSetting('antiCache');}else{url=url+'?v='+ips.getSetting('antiCache');}
if(!$('link[href="'+url+'"]').length){var stylesheet=document.createElement("link");stylesheet.setAttribute("href",url);stylesheet.setAttribute("rel","stylesheet");stylesheet.setAttribute("media","all");$('head')[0].appendChild(stylesheet);Debug.log("Added stylesheet "+url+" to document");}});},updatePriceAndStock:function(){var self=this;var form=this.scope.find('form');ips.getAjax()(form.attr('action'),{dataType:'json',data:form.serialize()+'&stockCheck=1',type:'post'}).done(function(response){self.scope.find('[data-role="price"]').html(response.price);self.scope.find('[data-role="stock"]').html(response.stock);self.scope.find('[data-role="renewalTerm"]').html(response.renewal);self.scope.find('[data-role="initialTerm"]').html(response.initialTerm);if(response.okay){form.find('button').removeAttr('disabled').text(ips.getString('add_to_cart_js'));}else{form.find('button').attr('disabled','disabled').text(ips.getString('out_of_stock'));}}).fail(function(response){Debug.error(response);});}});ips.controller.mixin('submit','nexus.front.store.packagePage',true,function(){this.after('addToCart',function(event){const quantity=$('#quantity_input_hidden').prop('outerHTML');$(document).on('contentChange',function(){let form=$(event.target).find('form');const packageInput=form.find('input[name^="package_"]');const packageName=packageInput.attr('name');const isQuantity=form.find("#quantity_input_hidden");const packageNumber=packageName.match(/package_(\d+)_submitted/);let number=null;if(packageNumber){number=packageNumber[1];$('#package_'+number+"_quantity").remove();}
if(isQuantity.length===0){form.append(quantity);}});});});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('prodcluster.front.store.page',{_productURL:'',initialize:function(){this.on("click","button.elCluster_button",this.updateForm);this.setup();},setup:function(){const quantityDown=$('.quantity_down');const quantityUp=$('.quantity_up');this.updateQuantityDisplay(1);this.toggleButtonState();quantityDown.on('click',()=>this.decrementQuantity());quantityUp.on('click',()=>this.incrementQuantity());},updateQuantityDisplay:function(quantity){$('#cluster_input_quantity').val(quantity);$('#quantity_input_hidden').val(quantity);},updateQuantityAttribute:function(quantity){$('#cluster_input_quantity').data("stocklevel",parseInt(quantity)).data("max",parseInt(quantity));},toggleButtonState:function(){const quantityInput=$('#cluster_input_quantity');const quantityDown=$('.quantity_down');const quantityUp=$('.quantity_up');const maxQuantity=parseInt(quantityInput.data("stocklevel"));const currentQuantity=parseInt(quantityInput.val());quantityDown.toggleClass('disabled',currentQuantity<=1);quantityUp.toggleClass('disabled',currentQuantity>=maxQuantity);},decrementQuantity:function(){const quantityInput=$('#cluster_input_quantity');let currentQuantity=parseInt(quantityInput.val());if(currentQuantity>1){this.updateQuantityDisplay(currentQuantity-1);}
this.toggleButtonState();},incrementQuantity:function(){const quantityInput=$('#cluster_input_quantity');const maxQuantity=parseInt(quantityInput.data("stocklevel"));let currentQuantity=parseInt(quantityInput.val());if(currentQuantity<maxQuantity){this.updateQuantityDisplay(currentQuantity+1);}
this.toggleButtonState();},updateStock:function(form){let self=this;ips.getAjax()(this._productURL,{dataType:'json',data:form.serialize()+'&stockCheck=1',type:'post'}).done(function(response){const newStock=response.stock==null||response.stock===""?9999999:response.stock;self.updateQuantityAttribute(newStock);self.toggleButtonState();}).fail(function(response){Debug.error(response);});},updateForm:function(event){let form=$('div[data-controller="nexus.front.store.packagePage"]').find("form");let buttons=$('.elCluster_button');const priceProduct=$(".cNexusPrice > span");event.preventDefault();buttons.removeClass('active');if(!$(event.target).hasClass('active')){$(event.target).addClass('active');}
priceProduct.replaceWith("<span data-role='price'>"+$(event.target).attr("data-price")+"</span>");let formDims=ips.utils.position.getElemDims(form);let formPos=ips.utils.position.getElemPosition(form);let loadingElem=$('<div/>').addClass('ipsLoading');form.after(loadingElem);loadingElem.css({top:formPos.offsetPos.top+'px',left:formPos.offsetPos.left+'px',width:formDims.outerWidth+'px',height:formDims.outerHeight+'px'});this._productURL=$(event.target).attr("data-url");ips.getAjax()("/store/prodcluster/"+$(event.target).data('product-id')+"-prod_cluster",{type:'post'}).done((response)=>{const quantity=$('#quantity_input_hidden').prop('outerHTML');const loadingElem=form.next('.ipsLoading');if(loadingElem.length)loadingElem.remove();form.replaceWith(response);const newForm=$('form');newForm.attr('action',this._productURL);this.updateQuantityDisplay(1);this.updateStock(newForm);$(document).trigger('contentChange',[form]);}).fail((response)=>{console.error("AJAX request failed:",response);});}});}(jQuery,_));;